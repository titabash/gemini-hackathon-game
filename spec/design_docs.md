# Design Doc：GenUI×Flame×AI GM TRPG（Supabase＋Python）— ゲームデザイン＆UX

## 0. このドキュメントの目的

* **ゲームデザイン**と**ユーザー体験（UX）**にフォーカスして、MVPの仕様を固める。
* 実装詳細（コード、ディレクトリ構造、SDKの接続手順）は扱わない。
* バックエンドはPython、永続化はSupabase（Postgres/JSONB）。

---

## 1. プロダクトの北極星（North Star）

### 1.1 体験コンセプト

* 「自由入力で何でもできる」即興TRPG体験を、

  * **AI GM（監督）**
  * **Choice（選択肢）**
  * **軽量な盤面演出（Flame）**
    で“遊べる形”に落とす。

### 1.2 MVPの成功条件

* プレイヤーが「入力 → 世界が反応 → 次のフックが出る」のループをストレスなく回せる。
* AIのブレ/誤解釈が起きても、UX上の安全弁（Undo/Retry/Edit）で破綻せず続行できる。
* NPCが複数出ても、会話/行動が散らからず“生きてる感”が出る。

---

## 2. MVPスコープ（最低限“遊べる”だけに絞る）

### 2.1 MVPで入れる“楽しい要素”の最小セット

MVPはジャンル未確定でも成立する、以下だけに絞る。

1. **即興TRPGのコアループ**

* 自由入力（Do/Say）→ 世界の反応（ノベル）→ 次のフック

2. **意味のある選択（Choice）**

* 迷いどころで3〜6択
* 最後に「自由入力で別案」

3. **緊張感（Roll）**

* 成否で結果が変わる判定
* “賭け（stakes）”を短く明示（成功/失敗で何が起こるか）

4. **複数NPCの“生きてる感”**

* NPCは複数登場
* 発話は最大2人に絞り、他は地の文で要約
* NPC→PCの関係値（好感度など）が反応に影響

5. **継続性（進捗）**

* セッション保存/復帰
* 目的・手がかり・未解決を短く提示（迷子防止）

6. **安全弁（壊れても続けられる）**

* Undo / Retry / Edit（入力補正）

### 2.2 MVPで入れない（後回し）

* 立ち絵のAI動的生成（立ち絵は事前同梱のみ）
* マルチプレイヤー同期
* 重い戦闘シミュレーション
* 大規模ワールドビルダーUI
* 複雑なクラフト/経済/育成システム

> **注: MVPでのアセット方針**
>
> | アセット種別 | MVP対応 |
> |-------------|---------|
> | **立ち絵（PC/NPC）** | 事前同梱のみ。動的生成は将来拡張 |
> | **背景画像** | 事前同梱＋**動的生成**（未知のロケーション遷移時にAIが生成） |
> | **アイテム画像等** | 事前同梱のみ |
>
> 自由入力でプレイヤーがどこにでも移動できるTRPGの特性上、背景画像のみ動的生成をMVPで対応する。

---

## 3. ゲームループ（プレイヤー視点）

### 3.1 コアループ（1ターン）

1. **入力**：Do（行動）またはSay（発話）で自由入力
2. **GM判断**：AI GMが「この入力をどう扱うか」を決める（narrate / choice / roll / clarify / repair）
3. **解決**：

   * narrate：短いノベル出力（1〜2段落）
   * choice：選択肢（3〜6）＋「自由入力で別案」
   * roll：判定UI → ルール確定 → 結果のノベル
   * clarify：確認質問（1つ）＋2〜4択
   * repair：整合性修正（矛盾/誤解釈の補正）
4. **停止点**：Continue（ページめくり）か次Choiceを提示

### 3.2 “ノベルの長さ”の標準

* 通常：**1〜2段落（150〜350文字目安）**
* 判定結果：**80〜200文字**（結果→次のフックに集中）
* シーン転換：**300〜600文字**（Continueで分割）

> 自由度が高いほど、長文は無駄になりやすい。標準は短く。

---

## 4. GenUIをどう使うか（本ドキュメントの中核）

### 4.1 役割分担

* **GenUI**：TRPGの“進行”と“操作”を担当

  * GM本文（地の文/会話）
  * 停止点（Continue）
  * Choice（選択肢）
  * Roll（判定UI：技能/難易度/賭け）
  * Clarify（確認質問）
  * Repair（矛盾修正の確認UI）
  * （将来）インベントリ/クエスト/人物相関などの管理UI
* **Flame**：盤面/位置/注目対象/軽演出（没入補助）

> **重要**：MVPでは「UIを全部生成」ではなく、
>
> * 入力欄（Do/Say）やUndo/Retry/Editは**固定UI**
> * GMが出す“その場のUI”（Choice/Roll/Continue等）を**GenUI生成**
>   のハイブリッドにする。

### 4.2 GenUIが生むゲーム体験（従来の条件分岐UIとの違い）

* 従来：想定分岐をコードで列挙し、各画面/状態を固定化
* GenUI：GM（AI）が**その瞬間の文脈**から

  * 何を提示すべきか（ChoiceかRollかClarifyか）
  * どう提示すべきか（項目数、ラベル、補足、賭けの説明）
    を組み立てる（ただし許可したUI部品だけ）

結果として：

* 自由入力でも迷子になりにくい（必要なときにだけ収束UIが出る）
* ルール処理が“UIとして見える”（判定の賭けが明示される）
* NPCが多いときも会話/行動の焦点がUIで整理される

### 4.3 GenUIの最小UI語彙（Catalogの考え方）

MVPで許可するUI語彙を限定し、GMが迷わず安定した出力をできるようにする。

* **narrationBlock**：本文段落（話者ラベル/視点ラベル対応）
* **continue**：ページめくり
* **choiceGroup**：選択肢（3〜6）＋「自由入力で別案」
* **rollPanel**：技能/難易度/賭け→Roll
* **clarifyQuestion**：確認質問＋2〜4択
* **repairConfirm**：矛盾修正の確認（差分/採用/却下）
* **sceneCard**：現在地/目的/手がかり（短い）

> 将来は `inventoryPanel`、`relationshipPanel`、`questLog` を足す。

### 4.4 GenUIのターン内ストリーム（段階出力でUXを守る）

MVPの原則：**長い待ちを作らない**。

* 1段目：本文（短い）＋停止点UI（Continue/Choice/Roll）
* 2段目：必要なら補足（NPCの短い追加台詞、状況カードの更新）

プレイヤーは1段目で既に「読む/選ぶ/進める」が可能。

---

## 5. 画面構成（UX）

### 5.1 メイン画面（常時表示の3エリア）

A) **Flameキャンバス（盤面/演出）**

* 現在地の背景画像＋NPC/PCの立ち絵を配置
* 話者ハイライト（発言中のNPCの立ち絵を強調、非発言NPCは半透明）
* 視線誘導（誰が話しているか、危険が迫っているか）を立ち絵の演出で支援

B) **ノベル/会話ログ（読み物領域）**

* 地の文＋会話（話者ラベル付き）
* 直近の出来事が読み返せる

C) **操作領域（入力＆停止点）**

* Do/Say切替＋自由入力欄（固定UI）
* GenUI生成：Choice/Roll/Continue/Clarify/Repair

### 5.2 セッション操作（安全弁）

* **Undo**：1手戻す（状態とログを巻き戻す）
* **Retry**：同じ入力で再生成（違う展開を引く）
* **Edit**：直前のプレイヤー入力の軽微修正（誤字/対象/意図の補正）

> Editは「世界改変」ではなく「入力補正」。TRPGのプレイ感を壊さない。

---

## 6. 入力デザイン（自由入力＋Choiceのハイブリッド）

### 5.1 Do / Say（自由入力）

* Do：行動宣言（例："物陰に隠れて様子を見る"）
* Say：台詞（例："ここは任せて"）

#### 入力のガイド（軽く）

* UI上に短いヒント：

  * Do：何をどうするか（対象/手段/目的）
  * Say：誰に何を言うか（相手/意図）

### 5.2 Choice（収束用の補助輪）

* GMが迷いを検知したときに提示
* 選択肢は3〜6個に制限
* 最後に必ず **「自由入力で別案」** を用意（自由度を落とさない）

### 5.3 Clarify（確認質問）

* “曖昧さ”をChoiceにする前に、まずは1問で解消できるならClarify
* 例："『調べる』の対象は？" → 入口 / 周囲 / 地面 / NPC

---

## 6. GM（監督）パターン（案A）

### 6.1 GMの役割

* **世界の整合性**を担保する（死んだNPCが喋らない等）
* **テンポ**を統制する（台詞を絞る、要約する）
* **ルール処理**の入口を判断する（rollに落とす/落とさない）
* **NPC意図**を採用/却下/要約する（全員が勝手に喋らない）

### 6.2 GM判断（Decision）の基準

* narrate：単一意図で進行可能、危険が低い
* roll：成功/失敗で結果が大きい、緊張感を作りたい
* choice：不可逆の分岐、妥当案が複数、焦点が定まらない
* clarify：1問で入力の意図が確定する
* repair：矛盾が出た/誤解釈が濃厚/事実の確定が必要

---

## 7. NPC設計（“意思がある感”を作る）

### 7.1 NPCの基本データ

* プロフィール（口調、価値観、禁則）
* 目的（短期/中期/長期）
* 状態（場所、状態異常、所持品など）
* 関係値（PCごと）

### 7.2 関係値（TRPGらしいパラメータ）

MVPの標準スロット（NPC→PCごとに保持）

* affinity：好感度（-100..100）
* trust：信頼（0..100）
* fear：恐怖（0..100）
* debt：恩/貸し借り（整数）
* flags：離散フラグ（例：knows_secret / romance_locked）

### 7.3 NPCの“行動”は提案、決定はGM

* NPCは毎ターン喋らない。
* NPCは「何をしたいか（intent）」と「喋るなら短文」を提案する。
* GMが採用するのは原則：

  * 主役NPC + 1（最大2人）
  * それ以外は地の文でまとめる

### 7.4 複数NPCがいるシーンの会話演出

* **会話の焦点**を明示（今は誰との会話か）
* 他NPCは割り込みを“イベント”として短く（視線/物音/囁き）
* Flame側で話者の立ち絵をハイライト（明度UP＋スケール微拡大）し、非話者は半透明化して読みの負担を減らす

---

## 8. Flameの役割（TRPG“っぽさ”を上げる最低限）

### 8.1 Flameでやること（MVP）

* **NPC/PCの立ち絵表示**：シナリオに同梱された立ち絵画像をFlame盤面上に配置
  * 話者ハイライト（発言中のNPCを強調、非発言NPCは半透明化）
  * 感情表現（mood に応じた簡易エフェクト：cautious→影、alert→！マーク、terrified→震え等）
  * NPCの出現/退場アニメーション（フェードイン/アウト）
* **現在地の背景画像**：`scene_backgrounds` からロケーション背景を全画面表示
  * 事前同梱の背景：シナリオ定義済みロケーション用
  * 動的生成の背景：プレイ中に未知のロケーションへ遷移した際、AIが生成して `scene_backgrounds`（session_id紐づき）に保存
* **注目対象のハイライト**：会話の焦点となるNPCを視覚的に明示
* **軽いアニメーション**（近づく/逃げる/注視）：立ち絵の位置移動やスケール変化で表現

### 8.2 立ち絵の表示仕様

* **画像ソース**：シナリオの `initial_state` 内の `imagePath` で指定（Supabase Storage `scenario-assets` バケット）
* **推奨サイズ**：512×1024px、透過WebP/PNG
* **配置ルール**：
  * アクティブNPC（`isActive: true`）のみ盤面に表示
  * 非アクティブNPC（未発見キャラ等）は発見イベントまで非表示
  * 立ち絵の左右配置は登場順またはシーンコンテキストで決定
* **状態反映**：
  * `mood` に応じたビジュアルエフェクト（色調変化、アイコンオーバーレイ等）
  * `flags`（例：`armed`、`restrained`）に応じた小アイコン表示
  * HP低下時の表現（彩度低下等）

### 8.3 Flameでやらないこと（MVP）

* 正確な戦闘レンジ計算
* パスファインディング
* 複雑な物理
* 立ち絵の動的AI生成（事前同梱アセットのみ使用）
* アイテム画像の動的AI生成（事前同梱アセットのみ使用）

> Flameは”没入感の補助”に徹し、ゲーム進行はGenUI側のノベル/選択に寄せる。

---

## 9. 遅延を体験に変える（UX対策）

### 9.1 段階出力

* 本文を先に短く出す → 次の選択肢/判定UI
* NPCの細かい台詞や補足は後から（必要なら）

### 9.2 待ち時間の見せ方

* 「GMが考えている」表示（短い）
* Flame側で状況演出（雨音、遠景の影など）
* 直近ログの読み返しができる（待ち中も手が止まらない）

---

## 10. セッションの長期安定（コンテキスト設計）

### 10.1 3層コンテキスト

* 常時：目的/危機/重要NPC/未解決（Plot Essentials）＋短期要約
* 条件付き：NPC/場所/組織カード（キーワードで注入）
* 直近ログ：数手分

### 10.2 要約の入れどころ

* 2〜3手ごとに短い要約を更新
* 重要イベント発生時に「確定事実」を箇条書きで更新

---

## 11. Supabase（永続化）に関するUX要件

* セッション一覧：

  * 最終更新日時
  * タイトル
  * 直近要約（1行）
* 復帰時：

  * 直近ログを少し表示して思い出せる
  * 直近の選択肢/目的を再提示

> データモデル自体は別設計（JSONB）で持つが、このドキュメントではUX要件のみ。
> ここで言うJSONBは主に、
>
> * **関係値（NPC→PCの好感度/信頼/恐怖/恩など）**
> * **ゲーム特有の行動決定パラメータ**（例：SAN/AGI/STR/技能/所持品/状態/クエスト進行など、ユーザアクション後の成否・反応・分岐に影響する値）
>   を柔軟に保持するためのもの。
>   これらはAI GMのDecision（roll/choice/narrate等）やルール確定に直接使われる。

---

## 12. MVPの“シナリオテンプレ”の考え方（ジャンル未確定でも固める）

ジャンルが未決でも、テンプレはこの形にする。

* プレイヤーの初期状況（場所/目的/制約）
* 重要NPC 1〜2人（関係値つき）
* 謎/課題 1つ（未解決フラグ）
* 危機 1つ（時間制限 or 迫る脅威）

これだけで、自由入力の方向性が定まり、GMの判断も安定する。

---

## 13. エンディング設計（TRPGライクに成立させるために必須）

### 13.1 目的

* TRPGライクに「一連の冒険が終わった」という満足感を作る。
* 自由入力で脱線しても、

  * **到達可能なゴール**
  * **到達できなかった場合の結末（バッド/ゲームオーバー）**
    を明確に用意して、セッションを“閉じる”。

### 13.2 MVPでのエンディングの最小構成

* **Good End（1つ）**：主目的の達成
* **Bad End（1つ以上）**：主目的未達、または重大失敗
* **Game Over（1つ以上）**：行動不能/時間切れ/取り返しのつかない破綻

> MVPは複数ルート分岐を作り込みすぎず、まずは「終わり方の型」を固定する。

### 13.3 エンディングへの到達条件（設計の形）

エンディングは、AIの気分で決めず **状態（JSONB）で判定**する。

* `winConditions[]`：勝利条件（例：証拠を揃える、NPCを説得する、脱出する）
* `failConditions[]`：敗北条件（例：SAN<=0、HP<=0、time>=limit、重要NPC死亡）
* `softFail`：軽い失敗（情報不足、関係値低下、次の難易度上昇）

### 13.4 “詰み”を防ぐ（TRPGのGMらしさ）

MVPは「完全に詰む」よりも「失敗を前進に変える（fail-forward）」を基本にする。

* 失敗＝即ゲームオーバーではなく、

  * 手がかりが減る
  * 時間が進む
  * 関係値が悪化する
  * 次のロールが不利になる
    などの **代償** を与える。

ただし以下は **明確なゲームオーバー** として扱う（TRPGの緊張感維持）。

* 行動不能（HP<=0等）
* タイムリミット超過
* 取り返しのつかない重大破綻（例：逃走不能な拘束）

### 13.5 エンディング時のUX（終了画面の最低要件）

* **Epilogue（短い）**：1〜3段落で結末
* **結果サマリ**：

  * 達成した条件/未達の条件
  * 主要NPCの関係値の最終値（好感度/信頼など）
  * 重要フラグ（真相解明、救出成功など）
* **リプレイ導線**：

  * 最後の分岐へ戻る（チェックポイント）
  * もう一度最初から

> Undo/Retry/Editは道中の安全弁。
> エンディングは「セッションを締める」ための満足弁。

### 13.6 GM（Decision）への影響

* `risk_level` が高い行動では、GMは必ず

  * 失敗時の代償（softFail）
  * あるいはゲームオーバー条件への接近
    を短く明示する（賭け＝stakes）。

---

## 14. 受け入れ基準（DoD）

---

## 13. 体験が一発で伝わるプレイ例（5〜7分のミニセッション）

> ここでは「このDesign Docのゲームが完成すると、ユーザーは何をどう体験するか」を、
> 実際の画面遷移と入力の流れで示す。

### 13.1 画面の見え方（常時）

* **左/上：Flame盤面**：背景画像＋NPC/PCの立ち絵、話者ハイライト、感情エフェクト、軽い演出（近づく/視線/物音）
* **中央：ノベル/会話ログ**：地の文＋会話（話者ラベル）
* **下：入力＆停止点**：

  * 固定UI：Do/Say切替＋自由入力欄、Undo/Retry/Edit
  * GenUI生成：Continue / Choice / Roll / Clarify / Repair

---

### 13.2 ミニセッション例：『倉庫街の失踪事件』

#### 登場

* PC：あなた（探索者）
* NPC：情報屋リオ（好感度/信頼が低い）、見張りの男（敵寄り）

#### 0) 開始（narrate + Continue）

* **ノベル**：

  * 「雨の倉庫街。失踪者の最後の目撃地点はこの近く…」
  * 「情報屋リオが待つ酒場は目の前だ。」
* **Flame**：酒場の背景画像＋リオの立ち絵（半透明、店内にいることを示唆）、PCは画面手前側に配置
* **GenUI**：`Continue`

ユーザーは「読む→Continue」を押す。

---

#### 1) 自由入力（Say）→ GMがClarify（確認質問）

* ユーザー（Say）：「リオに失踪者のことを聞く」
* GM判断：相手・口調・要求の有無が曖昧 → `clarify`
* **GenUI（Clarify）**：

  * 質問：「どう切り出す？」
  * 2〜4択：

    * 丁寧に頼む（信頼を上げる）
    * 金を出す（取引）
    * 脅す（恐怖を上げる）
    * 自由入力で別案
* **Flame**：リオの立ち絵が明るくハイライト（会話の焦点が明確）、mood: cautious の影エフェクト

ユーザーは「金を出す」を選ぶ。

---

#### 2) Choice選択 → GMがRollを提示（交渉）

* GM判断：金額/説得の成否で情報量が変わる → `roll`
* **GenUI（Roll）**：

  * 技能：交渉
  * 難易度：中
  * 賭け（stakes）：

    * 成功：核心の手がかり
    * 失敗：曖昧な噂のみ（次の手間が増える）
  * `Roll`

ユーザーがRoll。

* **結果（ノベル）**：

  * 成功なら「裏口に運び込まれた。見張りがいる。」
  * 失敗なら「倉庫街の噂は多い。追加の証拠が必要だ。」
* **関係値が変化**：

  * 取引成立でリオの `trust` が少し上がる、など

---

#### 3) ノベル（短い）→ 次の行動をChoiceで提示

* **ノベル**：

  * 「倉庫の裏口には見張り。雨音で足音は消えるが、灯りが強い。」
* **Flame**：倉庫裏口の背景画像に切替、見張りの男の立ち絵（mood: alert、！マークエフェクト）、ライト範囲を薄く表示
* **GenUI（Choice）**：

  * そっと近づく（隠密）
  * 遠回りして裏手へ（時間がかかる）
  * 物陰から様子を見る（観察）
  * 自由入力で別案

ユーザーは「物陰から様子を見る」。

---

#### 4) 自由入力（Do）→ GMがnarrate（短い反応）

* GM判断：軽い観察で進行可 → `narrate`
* **ノベル**：

  * 「見張りは一人。ときどき裏口を確認し、合図の癖がある。」
  * 「合図の瞬間に動けば、気づかれにくい。」
* **GenUI**：`Continue` または小Choice

ここでユーザーは「続けて自由入力」でも「Choice」でも進められる。

---

#### 5) 失敗しても楽しい（Undo/Retry/Editが効く）

例：ユーザーが自由入力で「背後から殴る」と入力して、GMが想定外に“致命的”な展開を返した場合。

* ユーザーは：

  * **Undo**：1手戻して別行動に
  * **Retry**：同じ入力で別の反応（ばらつき）
  * **Edit**：入力を「気絶させたい」に修正して意図を明確化

→ 自由入力の事故を「ゲームオーバー」にせず、「やり直し可能なTRPG」にする。

---

### 13.3 この体験の特徴（ユーザーが感じる価値）

* **自由入力で即興**できるのに、迷うときは**Choiceが出て道が見える**
* 成否が変える場面では**Rollで緊張感が生まれる**（賭けが見える）
* NPCが複数いても、会話の焦点が**ハイライトと台詞制限で散らからない**
* 破綻や誤解釈が起きても、**Undo/Retry/Editで物語を継続できる**

---

## 14. 受け入れ基準（DoD）

* 自由入力（Do/Say）→ GM応答（narrate/choice/roll/clarify/repair）が成立
* Choiceは3〜6択で、必ず「自由入力で別案」がある
* 複数NPCの登場が可能で、台詞は最大2人に絞られる
* Undo/Retry/Editで破綻や誤解釈から回復できる
* セッション保存/復帰ができ、復帰時に状況が理解できる

---

## 14. 将来拡張（ジャンル追加のための余白）

* `relations` スロットの拡張（例：romance/hostility/faction）
* 条件付きカード（NPC/場所/組織）を編集できるUI
* 戦闘を「宣言→一括解決」に拡張
* 立ち絵のAI動的生成/差し替え（プレイ中のリアルタイム生成）
* アイテム画像のAI動的生成

---

## 付録：用語

* **停止点**：Continue/Choice/Rollなど、プレイヤーが次に押す/選ぶポイント
* **Decision**：GMが「今回はどう進めるか」を決めるルーティング結果
* **監督（案A）**：NPCの提案を採用/却下し、整合性とテンポを守るGM構造
